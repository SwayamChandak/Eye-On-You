<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Complete Payment - Eye-On-You</title>
    <style>
        :root {
            --bg: #0b1020;
            --card: #111934;
            --text: #f7f9ff;
            --accent: #6aa3ff;
        }
        
        body {
            font-family: system-ui, sans-serif;
            margin: 0;
            background: var(--bg);
            color: var(--text);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        
        .container {
            background: var(--card);
            border-radius: 12px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.35);
            padding: 32px;
            max-width: 500px;
            text-align: center;
        }
        
        h1 {
            font-size: 24px;
            margin-bottom: 16px;
            color: var(--accent);
        }
        
        p {
            color: #a8b3cf;
            margin-bottom: 24px;
        }
        
        .loading {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid rgba(106, 163, 255, 0.2);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .success {
            color: #66e0c2;
            font-size: 18px;
            margin-top: 16px;
        }
        
        .error {
            color: #ff6b6b;
            font-size: 18px;
            margin-top: 16px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîê Complete Payment</h1>
        <p id="message">Initializing payment gateway...</p>
        <div class="loading" id="loading"></div>
        <div id="status"></div>
    </div>

    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <script>
        // Get order details from URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const orderId = urlParams.get('orderId');
        const amount = urlParams.get('amount');
        const currency = urlParams.get('currency');
        const username = urlParams.get('username');
        const email = urlParams.get('email');

        if (!orderId) {
            document.getElementById('message').textContent = 'Invalid payment request';
            document.getElementById('loading').style.display = 'none';
            document.getElementById('status').innerHTML = '<div class="error">‚ùå Order ID not found</div>';
        } else {
            // Initialize Razorpay checkout
            const options = {
                key: "rzp_test_RZfOfg4ZK6qdnl",
                amount: amount,
                currency: currency || "INR",
                name: "Eye-On-You",
                description: "Password Change Fee",
                order_id: orderId,
                handler: function (response) {
                    console.log("üí≥ Payment successful!");
                    console.log("Payment ID:", response.razorpay_payment_id);
                    console.log("Order ID:", response.razorpay_order_id);
                    console.log("Signature:", response.razorpay_signature);

                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('message').textContent = 'Payment completed!';
                    document.getElementById('status').innerHTML = '<div class="success">‚úÖ Payment successful! You can close this window.</div>';

                    // Send payment details back to extension
                    // Store in localStorage for extension to read
                    const paymentData = {
                        success: true,
                        razorpay_payment_id: response.razorpay_payment_id,
                        razorpay_order_id: response.razorpay_order_id,
                        razorpay_signature: response.razorpay_signature,
                        timestamp: Date.now()
                    };
                    localStorage.setItem('payment_result', JSON.stringify(paymentData));

                    // Close window after 3 seconds
                    setTimeout(() => {
                        window.close();
                    }, 3000);
                },
                prefill: {
                    name: username || "",
                    email: email || ""
                },
                notes: {
                    purpose: "password_change",
                    username: username
                },
                theme: {
                    color: "#6aa3ff"
                },
                modal: {
                    ondismiss: function() {
                        console.log("Payment cancelled by user");
                        document.getElementById('loading').style.display = 'none';
                        document.getElementById('message').textContent = 'Payment cancelled';
                        document.getElementById('status').innerHTML = '<div class="error">‚ùå Payment was cancelled</div>';

                        // Store cancellation result
                        const paymentData = {
                            success: false,
                            error: "Payment cancelled by user",
                            timestamp: Date.now()
                        };
                        localStorage.setItem('payment_result', JSON.stringify(paymentData));

                        setTimeout(() => {
                            window.close();
                        }, 2000);
                    }
                }
            };

            const rzp = new Razorpay(options);
            
            // Open checkout immediately
            document.getElementById('message').textContent = 'Opening payment gateway...';
            rzp.open();
        }
    </script>
</body>
</html>
